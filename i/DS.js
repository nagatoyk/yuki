/* <i.mouto.org> 多说评论部分 @卜卜口 */
window.DS_cfg?window.DS=function(l,d){if(!l){alert('无法读取多说信息')}$.ua=function(m){m=m||navigator.userAgent;return m.match(/Windows Phone/i)?'Mango':m.match(/Windows CE/i)?'winCE':m.match(/ipad/i)?'iPad':m.match(/iPod/i)?'Touch':m.match(/iphone/i)?'iPhone':m.match(/android/i)?'Android':m.match(/Ubuntu/i)?'Ubuntu':m.match(/Mac OS X/i)?'Mac OS X':m.match(/360/i)?'Shit!':m.match(/opera minf/i)?'Opera mini':m.match(/Chrome/i)?'Cr':m.match(/Safarf/i)?'Safari':m.match(/Opera/i)?'Opera':m.match(/UCWEB/i)?'UC':m.match(/PHP/i)?'PHP':''};$.t=function(n,m){!m&&(m=n)&&(n=document);return n.getElementsByTagName(m)};$.c=function(t,v){!v&&(v=t)&&(t=document);for(var u=' ',s=t.getElementsByTagName('*'),q=[],o=0,m;m=s[o];o++){(u+m.className+u).indexOf(u+v+u)==-1||q.push(m)}return q};$.lcss('i/DS.css');var h=function(m){return function(o,s,q,r,n){if(typeof s=='function'){r=q;q=s;s=0}if(m[o]){return q(m[o])}o='//'+l.id+'.duoshuo.com/api/'+o;n=d.XMLHttpRequest?new XMLHttpRequest():new ActiveXObject('Microsoft.XMLHTTP');if(!(n.withCredentials===undefined)){n.open(s?'POST':'GET',o,1);if(s){n.setRequestHeader('Content-Type','application/x-www-form-urlencoded')}n.withCredentials=1;if(q||r){n.onreadystatechange=function(){if(n.readyState==4){((n.status>199&&n.status<301)||n.status==304||n.status==400)?q(JSON.parse(n.responseText)):r(n.responseText,n.status)}}}n.send(s||'')}else{$.j(o.replace('.json','.jsonp')+(s?('&'+s):'')+'&callback={cb}',q||0)}}}({}),j=function(){var m=$.c('DS');for(var n in m){a(m[n])}},i=function(){var m=$('.-set');if(!m){m=$.D.m('div');m.className='DS-set h';m.innerHTML='<div class="DS-box"><span class="close">×</span><iframe src="http://duoshuo.com/settings/" scrolling="no"></iframe></div><div class="DS-setBg"></div>';$.D.a(m);m.className='DS-set';$('.DS-set .close').onclick=$('.DS-setBg').onclick=function(){$('.DS-set').className='DS-set h'}}else{m.className='DS-set'}return false},e=function(){for(var o=$.S('.DS a[href^="http://www.xiami.com/song/"]:not(.xiami)'),m=o.length,n=0;n<m;n++){o[n].className='xiami'}if(o.length){if(d.xiami){xiami.load()}else{$.j('i/xiami.js')}}},a=function(s,o){if(s.innerHTML){return}var r={listPostsUrl:'threads/listPosts.json?require=visitor%2Cnonce%2Cunread&',O:s,url:o};s.innerHTML='<div class="loading">评论载入中...</div>';if(o=s.getAttribute('data-url')){var q=encodeURIComponent,n,p='';var m=[];m.push('url='+q(o));if(n=s.getAttribute('data-key')){m.push('thread_key='+q(n))}r.W=m;h(r.listPostsUrl+m.join('&'),function(z){if(z.visitor){DS.U=z.visitor}s.innerHTML='<div class="DS-hot"></div><div class="DS-input"><div class="DS-v">'+g(z.visitor)+'</div>'+f(z.thread,z.nonce)+'</div><div class="DS-cmt"></div>';var x=$('.DS-cmt');$.D.a(x,c(z.response,z.parentPosts));e();if(z.cursor&&z.cursor.pages&&z.cursor.pages>1){var w=2;maxPage=z.cursor.pages,lPage=function(){if(w>maxPage){if(d.DsCmtClickId){d.scrollTo(0,$('#C-'+DsCmtClickId).offsetTop);DsCmtClickId=null}return}b(w,function(B){$.D.a(x,B);lPage()},r);w++};lPage()}if($('.DS-setBtn')){$('.DS-setBtn').onclick=DS.set}var v=$.t(s,'form')[0],u=v.message,t=function(){$('.DS-foRebox').innerHTML=v.parent_id.value=''};var y;if(y=$('.DS-visitor a[rel=nofollow]')){y.onclick=function(){k();return false}}u.value=($.cookie('cmTypeV')||'');u.onfocus=u.onchange=u.onkeypress=u.onkeyup=function(){$.cookie('cmTypeV',u.value);var B=u.value.match(/\n/g)||[];u.setAttribute('rows',B.length+3)};u.onkeydown=function(){u.onkeyup();if(window.event.ctrlKey&&window.event.keyCode==13){v.onsubmit();return false}};var A;if(A=$('.DS-smile')){$.x('i/smile',function(B){A.innerHTML='<b>(・ω・)</b><ul class="c "><li>'+B.split('\n').join('</li><li>')+'</li></ul>';$('.DS-smile b').onclick=function(){A.className=A.className=='DS-smile l'?'DS-smile l a':'DS-smile l';return false};$('.DS-smile ul').onclick=function(C){C=C||window.event;var D=C.srcElement||C.target;if(D.tagName=='LI'){u.focus();u.value+=' '+D.innerHTML+' '}}})}x.onclick=function(B){B=B||window.event;var D=B.srcElement||B.target;if(D.className.match(/fo/i)){v.parent_id.value=D.getAttribute('data-cid');var C=D.parentNode.parentNode;if($('.DS-visitor')){$('.DS-foRebox').innerHTML='<h3>正在回复这一条消息</h3><div class="DS-post">'+C.innerHTML+'</div><span class="close" title="取消回复">×</span>';$('.DS-foRebox .close').onclick=t;u.focus()}else{scrollTo(0,$('.DS').offsetTop)}}else{if(D.className.match(/like/i)){if(D.className=='like a'){D.innerHTML--;D.className='like'}else{D.innerHTML++;D.className='like a'}h('posts/vote.json','post_id='+D.getAttribute('data-cid')+'&vote='+(D.innerHTML))}}};v.onsubmit=function(){var C=u.value;if(!C){u.focus();return false}var B='thread_id='+v.thread_id.value+'&parent_id='+v.parent_id.value+'&nonce='+v.nonce.value+'&message='+encodeURIComponent(C)+'&v=131205';v.className='run';h('posts/create.json',B,function(F){if(F.errorMessage){alert(F.errorMessage);return}F=F.response;var G=$.D.m('ul');F.author.avatar_url=F.author.avatar_url||'//ds.cdncache.org/avatar-50/636/11505.jpg';G.innerHTML='<li id="C-'+F.post_id+'"><div class="DS-post">'+(F.author.url?'<a class="user" href="'+F.author.url+'" target="_blank"><img class="avatar" src="'+F.author.avatar_url+'">'+F.author.name+'</a>':'<span class="user"><img class="avatar" src="'+F.author.avatar_url+'">'+F.author.name+'</span>')+'<span class="agent">'+$.ua(F.agent)+'</span><p class="msg">'+F.message+'</p><div class="ctrl"><span>'+$.re_date(F.created_at)+'</span></div></li>';new Image().src='http://x.mouto.org/wb/x.php?itorr='+encodeURIComponent('@'+F.author.name+' 在 '+location.href+' 评论 「'+F.message+'」');var D;if(D=$('.DS-li_notice')){$.D.d(D)}var E;if(E=v.parent_id.value){G.className='child';$.D.a($('#C-'+E),G)}else{$.D.a($('.DS-cmt'),G)}e();t();$.cookie('cmTypeV',u.value='');scrollTo(0,G.offsetTop);$('.DS-smile').className='DS-smile l';setTimeout(function(){v.className=''},100)});return false}},function(t,u){/*$.x('x.php?act=log','E-DS-load DS_JSON->'+JSON.stringify(t)+' XHR_error->'+u);*/s.innerHTML='<div class="loading">评论载入失败OAQ</div>'})}else{console.log(s,'没设置url信息')}return},b=function(o,n,p){var m=p.W;m.push('page='+o);h(p.listPostsUrl+m.join('&'),function(q){n(c(q.response,q.parentPosts))})},g=function(q){var s='';if(q.user_id){s='<div class="DS-visitor"><div class="DS-foRebox"></div><div class="c"><div class="l"><span>'+q.name+'</span><!--a href="'+q.url+'" target="_blank"--></div><div class="r"><a target="_blank" class="DS-setBtn" href="//duoshuo.com/settings/">设置</a><a rel="nofollow" href>登出</a></div></div></div>'}else{s='<div class="DS-login"><h2>/*参与评论请先登录！*/</h2><p><span>多平台登录:</span>';var n=encodeURIComponent(location.href);for(var p=['weibo','qq','baidu','google','renren','douban','netease'],m=['微博','QQ','百度','谷歌','人人','豆瓣','网易'],o=p.length,r=0;r<o;r++){s+='<a class="DS-'+p[r]+'" href="//'+l.id+'.duoshuo.com/login/'+p[r]+'?redirect_uri='+n+'">'+m[r]+'</a>'}s+='</p></div>'}return s},f=function(m,n){return'<form method="post"><p><textarea name="message" rows="3" title="Ctrl+Enter快捷提交" placeholder="在这里评论哟～"></textarea></p><input type="hidden" name="thread_id" value="'+m.thread_id+'"><input name="parent_id" type="hidden"><input name="nonce" value="'+n+'" type="hidden"><!--<input type="checkbox" name="repost" value="weibo">--><div class="p c"><button class="l" type="submit">评论</button><smile class="DS-smile l"></smile></div></form>'},c=function(m,p){var o=function(s){var r='';if(!s){return r}r+='<ul class="child">';for(var q in s){s[q].author.avatar_url=s[q].author.avatar_url||'//ds.cdncache.org/avatar-50/636/11505.jpg';r+='<li id="C-'+s[q].post_id+'"><div class="DS-post">'+(s[q].author.url?'<a class="user" href="'+s[q].author.url+'" target="_blank"><img class="avatar" src="'+s[q].author.avatar_url+'">'+s[q].author.name+'</a>':'<span class="user"><img class="avatar" src="'+s[q].author.avatar_url+'">'+s[q].author.name+'</span>')+'<span class="agent">'+$.ua(s[q].agent)+'</span><p class="msg">'+s[q].message+'</p><div class="ctrl"><span>'+$.re_date(s[q].created_at)+'</span><span class="fo" data-cid="'+s[q].post_id+'">回应</span><span class="like'+(s[q].vote=='1'?' a':'')+'" data-cid="'+s[q].post_id+'">'+s[q].likes+'</span></div></div>'+o(s[q].children)+'</li>'}return r+'</ul>'},n=function(t,u){var s='';var r=$.D.m('ul');for(var q in t){u[t[q]].author.avatar_url=u[t[q]].author.avatar_url||'//ds.cdncache.org/avatar-50/636/11505.jpg';s+='<li id="C-'+u[t[q]].post_id+'"><div class="DS-post">'+(u[t[q]].author.url?'<a class="user" href="'+u[t[q]].author.url+'" target="_blank"><img class="avatar" src="'+u[t[q]].author.avatar_url+'">'+u[t[q]].author.name+'</a>':'<span class="user"><img class="avatar" src="'+u[t[q]].author.avatar_url+'">'+u[t[q]].author.name+'</span>')+'<span class="agent">'+$.ua(u[t[q]].agent)+'</span><p class="msg">'+u[t[q]].message+'</p><div class="ctrl"><span>'+$.re_date(u[t[q]].created_at)+'</span><span class="fo" data-cid="'+u[t[q]].post_id+'">回应</span><span class="like'+(u[t[q]].vote=='1'?' a':'')+'" data-cid="'+u[t[q]].post_id+'">'+u[t[q]].likes+'</span></div></div>'+o(u[t[q]].children)+'</li>'}if(s.length<5){s='<li class="DS-li_notice">沙发还在，还不快抢？</li>'}r.innerHTML=s;return r};return n(m,p)},k=function(){new Image().src='//'+l.id+'.duoshuo.com/logout/';$('.DS-v').innerHTML=g({})};return{load:j,U:{},set:i}}(DS_cfg,window):alert('请添加设置信息');DS.load();
/* 多说评论 End */